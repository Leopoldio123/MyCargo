<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–≥–∏—Å—Ç–∏–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); padding: 15px; padding-bottom: 80px; }
        .section { margin-bottom: 25px; }
        h2 { font-size: 18px; border-bottom: 2px solid #3390ec; padding-bottom: 8px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: border 0.3s; }
        input.error { border: 2px solid #ff4d4d; background-color: #fff0f0; } /* –°—Ç–∏–ª—å –æ—à–∏–±–∫–∏ */
        label { font-size: 12px; color: #777; font-weight: bold; margin-bottom: 4px; display: block; }
        .card { background: var(--tg-theme-secondary-bg-color, #f7f7f7); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .row { display: flex; gap: 10px; }
        .row div { width: 50%; }
        .btn-add { width: 100%; padding: 12px; border: 2px dashed #3390ec; color: #3390ec; background: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="section">
        <h2>üë§ –ó–∞–∫–∞–∑—á–∏–∫</h2>
        <label>–Æ—Ä. —Å—Ç–∞—Ç—É—Å</label>
        <select id="clientType">
            <option>–Æ—Ä. –õ–∏—Ü–æ</option>
            <option>–ò–ü</option>
            <option>–§–∏–∑. –õ–∏—Ü–æ</option>
        </select>
        <input type="text" id="companyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ / –§–ò–û">
        <input type="text" id="repName" placeholder="–ò–º—è –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è">
        <input type="tel" id="repPhone" class="phone-mask" placeholder="+7..." value="+7">
    </div>

    <div class="section">
        <h2>‚¨ÜÔ∏è –ü–æ–≥—Ä—É–∑–∫–∞</h2>
        <div id="loadingPoints"></div>
        <button class="btn-add" onclick="addPoint('load')">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
    </div>

    <div class="section">
        <h2>‚¨áÔ∏è –í—ã–≥—Ä—É–∑–∫–∞</h2>
        <div id="unloadingPoints"></div>
        <button class="btn-add" onclick="addPoint('unload')">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
    </div>

<script>
    // üî• –í–°–¢–ê–í–¨–¢–ï –°–í–ï–ñ–£–Æ –°–°–´–õ–ö–£ –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkwMeo9VG5FrMUv98zBE89CSxdB5mVR-C4V8dhVhEW_eMmqlWG1WSU6k_olWxPX0id/exec'; 

    let tg = window.Telegram.WebApp;
    tg.expand(); 

    // –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('phone-mask')) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.startsWith('7')) v = v.substring(1);
            if (v.startsWith('8')) v = v.substring(1);
            v = v.substring(0, 10);
            let res = '+7';
            if (v.length > 0) res += ' (' + v.substring(0,3);
            if (v.length >= 3) res += ') ' + v.substring(3,6);
            if (v.length >= 6) res += '-' + v.substring(6,8);
            if (v.length >= 8) res += '-' + v.substring(8,10);
            e.target.value = res;
        }
        // –£–±–∏—Ä–∞–µ–º –∫—Ä–∞—Å–Ω—É—é —Ä–∞–º–∫—É, –µ—Å–ª–∏ –Ω–∞—á–∞–ª–∏ –ø–µ—á–∞—Ç–∞—Ç—å
        if (e.target.classList.contains('error')) {
            e.target.classList.remove('error');
        }
    });

    function addPoint(type) {
        let container = document.getElementById(type === 'load' ? 'loadingPoints' : 'unloadingPoints');
        let idx = container.children.length + 1;
        let html = `
        <div class="card ${type}-card">
            <label>${type === 'load' ? '–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏' : '–ê–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏'} ${idx}</label>
            <input type="text" class="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞">
            
            ${type === 'load' ? `
            <div class="row">
                <div><label>–ì—Ä—É–∑</label><input type="text" class="cargo" placeholder="–ß—Ç–æ –≤–µ–∑–µ–º?"></div>
                <div><label>–í–µ—Å (–∫–≥)</label><input type="number" class="weight" placeholder="0"></div>
            </div>
            <label>–ì–∞–±–∞—Ä–∏—Ç—ã</label><input type="text" class="dims" placeholder="–î—Ö–®—Ö–í">
            ` : `
            <label>–î–æ–∫—É–º–µ–Ω—Ç—ã</label>
            <select class="docs">
                <option>–ü–µ—á–∞—Ç—å</option><option>–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</option><option>–ë–µ–∑ –ø–µ—á–∞—Ç–∏</option>
            </select>
            `}
            
            <label>–¢–∏–ø ${type === 'load' ? '–ø–æ–≥—Ä—É–∑–∫–∏' : '–≤—ã–≥—Ä—É–∑–∫–∏'}</label>
            <input type="text" class="type" placeholder="–ó–∞–¥–Ω—è—è / –ë–æ–∫–æ–≤–∞—è">
            
            <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
            <input type="text" class="contact" placeholder="–ò–º—è">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" class="phone phone-mask" placeholder="+7..." value="+7">
        </div>`;
        
        let div = document.createElement('div');
        div.innerHTML = html;
        container.appendChild(div);
    }

    // üî• –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò (–í–ê–õ–ò–î–ê–¶–ò–Ø)
    function validateForm() {
        let isValid = true;
        let firstError = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–∞–≤–Ω—ã–µ –ø–æ–ª—è
        let requiredIds = ['companyName', 'repName', 'repPhone'];
        requiredIds.forEach(id => {
            let el = document.getElementById(id);
            if (!el.value || el.value.length < 3) {
                el.classList.add('error');
                isValid = false;
                if(!firstError) firstError = el;
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
        document.querySelectorAll('.address, .cargo, .weight, .dims, .type, .contact, .phone').forEach(el => {
            if (!el.value) {
                el.classList.add('error');
                isValid = false;
                if(!firstError) firstError = el;
            }
        });

        if (!isValid) {
            tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è!");
            if(firstError) firstError.scrollIntoView({behavior: "smooth", block: "center"});
        }

        return isValid;
    }

    addPoint('load');
    addPoint('unload');

    tg.MainButton.setText("–û–§–û–†–ú–ò–¢–¨ –ó–ê–Ø–í–ö–£");
    tg.MainButton.show();

    tg.MainButton.onClick(() => {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞! –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è.
        if (!validateForm()) return;

        tg.MainButton.showProgress();

        let data = {
            client_type: document.getElementById('clientType').value,
            company: document.getElementById('companyName').value,
            rep_name: document.getElementById('repName').value,
            rep_phone: document.getElementById('repPhone').value,
            loading: [],
            unloading: []
        };

        // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–≥—Ä—É–∑–∫—É
        document.querySelectorAll('.load-card').forEach(el => {
            data.loading.push({
                address: el.querySelector('.address').value,
                cargo: el.querySelector('.cargo').value,
                weight: el.querySelector('.weight').value,
                dims: el.querySelector('.dims').value,
                type: el.querySelector('.type').value,
                contact: el.querySelector('.contact').value,
                phone: el.querySelector('.phone').value
            });
        });

        // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–≥—Ä—É–∑–∫—É
        document.querySelectorAll('.unload-card').forEach(el => {
            data.unloading.push({
                address: el.querySelector('.address').value,
                type: el.querySelector('.type').value,
                docs: el.querySelector('.docs').value,
                contact: el.querySelector('.contact').value,
                phone: el.querySelector('.phone').value
            });
        });

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => {
            tg.MainButton.hideProgress();
            tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
            tg.close();
        }).catch(() => {
            tg.MainButton.hideProgress();
            tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        });
    });
</script>
</body>
</html>
