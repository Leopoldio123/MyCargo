<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–µ—Ä–µ–≤–æ–∑–∫—É</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); padding: 20px; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; }
        h2 { border-bottom: 2px solid var(--tg-theme-button-color, #3390ec); padding-bottom: 10px; margin-top: 30px; font-size: 18px; }
        .card { background: var(--tg-theme-secondary-bg-color, #f5f5f5); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e0e0e0; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 13px; color: var(--tg-theme-hint-color, #555); }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        .btn-add { background: transparent; color: var(--tg-theme-button-color, #3390ec); border: 2px dashed var(--tg-theme-button-color, #3390ec); width: 100%; padding: 12px; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: var(--tg-theme-text-color, #000); }
        .row { display: flex; gap: 10px; }
        .row div { width: 50%; }
    </style>
</head>
<body>
<div class="container">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≥—Ä—É–∑–∞</h1>

    <div class="section">
        <h2>üë§ –ó–∞–∫–∞–∑—á–∏–∫</h2>
        
        <label>–¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</label>
        <select id="clientType">
            <option value="–Æ—Ä. –õ–∏—Ü–æ">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
            <option value="–ò–ü">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å</option>
            <option value="–§–∏–∑. –õ–∏—Ü–æ">–ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ</option>
        </select>

        <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –§–ò–û</label>
        <input type="text" id="companyName" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞">

        <label>–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–§–ò–û)</label>
        <input type="text" id="repName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω">

        <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="repPhone" class="phone-mask" placeholder="+7 (999) 000-00-00" value="+7">
    </div>

    <div class="section">
        <h2>‚¨ÜÔ∏è –ú–µ—Å—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏</h2>
        <div id="loadingPoints"></div>
        <button class="btn-add" onclick="addLoadingPoint()">+ –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏</button>
    </div>

    <div class="section">
        <h2>‚¨áÔ∏è –ú–µ—Å—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏</h2>
        <div id="unloadingPoints"></div>
        <button class="btn-add" onclick="addUnloadingPoint()">+ –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏</button>
    </div>
</div>

<script>
    // === –í–°–¢–ê–í–¨–¢–ï –í–ê–®–£ –°–°–´–õ–ö–£ –ù–ò–ñ–ï ===
    const SCRIPT_URL = 'https://script.google.com/macros/library/d/161yKDCubkBXtpRKaApNuKRMh_VkAXmg-cq0_En8_9nRXWzJnJ_X6lwmv/11'; 
    // =================================

    let tg = window.Telegram.WebApp;
    tg.expand(); 

    // –õ–æ–≥–∏–∫–∞ –º–∞—Å–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7 –∏ 10 —Ü–∏—Ñ—Ä)
    function applyPhoneMask(input) {
        input.addEventListener('input', function(e) {
            let value = input.value.replace(/\D/g, ''); // –£–¥–∞–ª—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
            if (value.startsWith('7')) value = value.substring(1); // –ï—Å–ª–∏ –µ—Å—Ç—å 7 –≤ –Ω–∞—á–∞–ª–µ, —É–±–∏—Ä–∞–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (value.startsWith('8')) value = value.substring(1); // –ï—Å–ª–∏ –Ω–∞—á–∞–ª–∏ —Å 8

            value = value.substring(0, 10); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10 —Ü–∏—Ñ—Ä–∞–º–∏

            let formatted = '+7';
            if (value.length > 0) formatted += ' (' + value.substring(0, 3);
            if (value.length >= 3) formatted += ') ' + value.substring(3, 6);
            if (value.length >= 6) formatted += '-' + value.substring(6, 8);
            if (value.length >= 8) formatted += '-' + value.substring(8, 10);
            
            input.value = formatted;
        });
        // –ó–∞–ø—Ä–µ—â–∞–µ–º —Å—Ç–∏—Ä–∞—Ç—å +7
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && input.value.length <= 2) {
                e.preventDefault();
            }
        });
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫ –≥–ª–∞–≤–Ω–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É —Å—Ä–∞–∑—É
    applyPhoneMask(document.getElementById('repPhone'));

    function createLoadingHTML(index) {
        return `
        <div class="card loading-card">
            <div class="section-title">–¢–æ—á–∫–∞ –ø–æ–≥—Ä—É–∑–∫–∏ ${index + 1}</div>
            
            <label>–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏</label>
            <input type="text" class="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º">

            <label>–•–∞—Ä–∞–∫—Ç–µ—Ä –≥—Ä—É–∑–∞</label>
            <input type="text" class="cargoType" placeholder="–ù–∞–ø—Ä: –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ">

            <div class="row">
                <div>
                    <label>–í–µ—Å (–∫–≥)</label>
                    <input type="number" class="cargoWeight" placeholder="100">
                </div>
                <div>
                    <label>–ì–∞–±–∞—Ä–∏—Ç—ã</label>
                    <input type="text" class="cargoDims" placeholder="–î—Ö–®—Ö–í">
                </div>
            </div>

            <label>–¢–∏–ø –ø–æ–≥—Ä—É–∑–∫–∏</label>
            <input type="text" class="loadType" placeholder="–ó–∞–¥–Ω—è—è / –ë–æ–∫–æ–≤–∞—è">

            <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
            <input type="text" class="contactName" placeholder="–§–ò–û">

            <label>–¢–µ–ª–µ—Ñ–æ–Ω –Ω–∞ –ø–æ–≥—Ä—É–∑–∫–µ</label>
            <input type="tel" class="contactPhone phone-mask" placeholder="+7..." value="+7">
        </div>`;
    }

    function createUnloadingHTML(index) {
        return `
        <div class="card unloading-card">
            <div class="section-title">–¢–æ—á–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ ${index + 1}</div>
            
            <label>–ê–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏</label>
            <input type="text" class="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞">

            <label>–¢–∏–ø –≤—ã–≥—Ä—É–∑–∫–∏</label>
            <input type="text" class="unloadType" placeholder="–ó–∞–¥–Ω—è—è / –ë–æ–∫–æ–≤–∞—è">

            <label>–î–æ–∫—É–º–µ–Ω—Ç—ã</label>
            <select class="docsType">
                <option value="–ü–µ—á–∞—Ç—å">–ü–µ—á–∞—Ç—å</option>
                <option value="–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å">–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</option>
                <option value="–ë–µ–∑ –ø–µ—á–∞—Ç–∏">–ë–µ–∑ –ø–µ—á–∞—Ç–∏</option>
            </select>

            <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
            <input type="text" class="contactName" placeholder="–§–ò–û">

            <label>–¢–µ–ª–µ—Ñ–æ–Ω –Ω–∞ –≤—ã–≥—Ä—É–∑–∫–µ</label>
            <input type="tel" class="contactPhone phone-mask" placeholder="+7..." value="+7">
        </div>`;
    }

    function addLoadingPoint() {
        let container = document.getElementById('loadingPoints');
        let div = document.createElement('div');
        div.innerHTML = createLoadingHTML(container.children.length);
        container.appendChild(div);
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫ –Ω–æ–≤–æ–º—É –ø–æ–ª—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        applyPhoneMask(div.querySelector('.phone-mask'));
    }

    function addUnloadingPoint() {
        let container = document.getElementById('unloadingPoints');
        let div = document.createElement('div');
        div.innerHTML = createUnloadingHTML(container.children.length);
        container.appendChild(div);
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫ –Ω–æ–≤–æ–º—É –ø–æ–ª—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        applyPhoneMask(div.querySelector('.phone-mask'));
    }

    addLoadingPoint();
    addUnloadingPoint();

    tg.MainButton.setText("–û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–Ø–í–ö–£");
    tg.MainButton.show();

    tg.MainButton.onClick(function() {
        tg.MainButton.showProgress();

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥—Ä—É–∑–∫–∏
        let loadPoints = [];
        document.querySelectorAll('.loading-card').forEach(card => {
            loadPoints.push({
                address: card.querySelector('.address').value,
                cargo: card.querySelector('.cargoType').value,
                weight: card.querySelector('.cargoWeight').value,
                dims: card.querySelector('.cargoDims').value,
                type: card.querySelector('.loadType').value,
                contact: card.querySelector('.contactName').value,
                phone: card.querySelector('.contactPhone').value
            });
        });

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –≤—ã–≥—Ä—É–∑–∫–∏
        let unloadPoints = [];
        document.querySelectorAll('.unloading-card').forEach(card => {
            unloadPoints.push({
                address: card.querySelector('.address').value,
                type: card.querySelector('.unloadType').value,
                docs: card.querySelector('.docsType').value,
                contact: card.querySelector('.contactName').value,
                phone: card.querySelector('.contactPhone').value
            });
        });

        let data = {
            client_type: document.getElementById('clientType').value,
            company: document.getElementById('companyName').value,
            rep_name: document.getElementById('repName').value,
            rep_phone: document.getElementById('repPhone').value,
            loading: loadPoints,
            unloading: unloadPoints
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            tg.MainButton.hideProgress();
            tg.showAlert("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
            tg.close();
        }).catch(err => {
            tg.MainButton.hideProgress();
            tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏.");
        });
    });
</script>
</body>
</html>


